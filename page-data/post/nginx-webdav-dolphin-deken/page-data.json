{"componentChunkName":"component---node-modules-gatsby-theme-yoshino-src-templates-post-jsx","path":"/post/nginx-webdav-dolphin-deken/","result":{"data":{"markdownRemark":{"frontmatter":{"date":"2021-05-22T23:50:00.000Z","tags":["Webdav","Nginx","Dolphin","踩坑"],"title":"Nginx webdav 在 Dolphin 上的一些坑","update":null},"timeToRead":4,"navHtml":"<ol class=\"nav\"><li class=\"nav-item nav-level-2\"><a class=\"nav-link\" href=\"#环境\"><span class=\"nav-number\">1.</span> <span class=\"nav-text\">环境</span></a><ol class=\"nav-child\"><li class=\"nav-item nav-level-3\"><a class=\"nav-link\" href=\"#服务器\"><span class=\"nav-number\">1.1.</span> <span class=\"nav-text\">服务器</span></a></li><li class=\"nav-item nav-level-3\"><a class=\"nav-link\" href=\"#客户端\"><span class=\"nav-number\">1.2.</span> <span class=\"nav-text\">客户端</span></a></li></ol></li><li class=\"nav-item nav-level-2\"><a class=\"nav-link\" href=\"#坑\"><span class=\"nav-number\">2.</span> <span class=\"nav-text\">坑</span></a><ol class=\"nav-child\"><li class=\"nav-item nav-level-3\"><a class=\"nav-link\" href=\"#无法上传大文件状态码-413\"><span class=\"nav-number\">2.1.</span> <span class=\"nav-text\">无法上传大文件(状态码: 413)</span></a><ol class=\"nav-child\"><li class=\"nav-item nav-level-4\"><a class=\"nav-link\" href=\"#原因\"><span class=\"nav-number\">2.1.1.</span> <span class=\"nav-text\">原因</span></a></li><li class=\"nav-item nav-level-4\"><a class=\"nav-link\" href=\"#解决方法\"><span class=\"nav-number\">2.1.2.</span> <span class=\"nav-text\">解决方法</span></a></li></ol></li><li class=\"nav-item nav-level-3\"><a class=\"nav-link\" href=\"#无法创建文件夹状态码-409\"><span class=\"nav-number\">2.2.</span> <span class=\"nav-text\">无法创建文件夹(状态码: 409)</span></a><ol class=\"nav-child\"><li class=\"nav-item nav-level-4\"><a class=\"nav-link\" href=\"#原因-1\"><span class=\"nav-number\">2.2.1.</span> <span class=\"nav-text\">原因-1</span></a></li><li class=\"nav-item nav-level-4\"><a class=\"nav-link\" href=\"#解决方法-1\"><span class=\"nav-number\">2.2.2.</span> <span class=\"nav-text\">解决方法-1</span></a></li></ol></li><li class=\"nav-item nav-level-3\"><a class=\"nav-link\" href=\"#无法删除文件夹状态码-409\"><span class=\"nav-number\">2.3.</span> <span class=\"nav-text\">无法删除文件夹(状态码: 409)</span></a><ol class=\"nav-child\"><li class=\"nav-item nav-level-4\"><a class=\"nav-link\" href=\"#原因-2\"><span class=\"nav-number\">2.3.1.</span> <span class=\"nav-text\">原因-2</span></a></li><li class=\"nav-item nav-level-4\"><a class=\"nav-link\" href=\"#解决方法-2\"><span class=\"nav-number\">2.3.2.</span> <span class=\"nav-text\">解决方法-2</span></a></li></ol></li><li class=\"nav-item nav-level-3\"><a class=\"nav-link\" href=\"#无法复制移动文件夹状态码-409\"><span class=\"nav-number\">2.4.</span> <span class=\"nav-text\">无法复制/移动文件夹(状态码: 409)</span></a><ol class=\"nav-child\"><li class=\"nav-item nav-level-4\"><a class=\"nav-link\" href=\"#原因-3\"><span class=\"nav-number\">2.4.1.</span> <span class=\"nav-text\">原因-3</span></a></li><li class=\"nav-item nav-level-4\"><a class=\"nav-link\" href=\"#解决方法-3\"><span class=\"nav-number\">2.4.2.</span> <span class=\"nav-text\">解决方法-3</span></a></li></ol></li></ol></li><li class=\"nav-item nav-level-2\"><a class=\"nav-link\" href=\"#不显示含非英文字符文件及文件夹\"><span class=\"nav-number\">3.</span> <span class=\"nav-text\">不显示含非英文字符文件及文件夹</span></a></li><li class=\"nav-item nav-level-2\"><a class=\"nav-link\" href=\"#成果\"><span class=\"nav-number\">4.</span> <span class=\"nav-text\">成果</span></a></li><li class=\"nav-item nav-level-2\"><a class=\"nav-link\" href=\"#参考\"><span class=\"nav-number\">5.</span> <span class=\"nav-text\">参考</span></a></li></ol>","excerpt":"ps: 要不是webdav可以用cdn，我会用它？ 环境 服务器 OS: ubuntu 21.04 x64 Docker: v19.03.13, build cd8016b6bc ugeek/webdav:amd64-alpine (ed65583ea58e) nginx: v1.19.7 客户端 OS: Archlinux Dolphin: v21.04.0 坑","html":"<p>ps: 要不是webdav可以用cdn，我会用它？</p>\n\n              <h2 id=\"环境\">\n                环境\n              </h2>\n              <h3 id=\"服务器\">\n                服务器\n              </h3><ul>\n<li>OS: ubuntu 21.04 x64</li>\n<li>Docker: v19.03.13, build cd8016b6bc<ul>\n<li>ugeek/webdav:amd64-alpine (ed65583ea58e)<ul>\n<li>nginx: v1.19.7</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n\n              <h3 id=\"客户端\">\n                客户端\n              </h3><ul>\n<li>OS: Archlinux</li>\n<li>Dolphin: v21.04.0</li>\n</ul>\n\n              <h2 id=\"坑\">\n                坑\n              </h2><!--more-->\n\n              <h3 id=\"无法上传大文件状态码-413\">\n                无法上传大文件(状态码: 413)\n              </h3><p>webdav 镜像本身没有这个问题，client_max_body_size 在主机配置文件中值为0。 </p>\n<p>我在另一台服务器使用 nginx 反代 webdav，但反代配置文件的 client_max_body_size 为 10M 导致无法上传大文件</p>\n\n              <h4 id=\"原因\">\n                原因\n              </h4><p>client_max_body_size 值过小</p>\n<blockquote>\n<p>Syntax:     client_max_body_size size;<br>Default:     client_max_body_size 1m;<br>Context:     http, server, location  </p>\n<p>设置客户端请求正文的最大允许大小。如果请求中的大小超过配置值，则向客户端返回413(请求实体过大)错误。请注意浏览器无法正确显示此错误。将配置值设置为0将禁用对客户端请求正文大小的检查。</p>\n</blockquote>\n\n              <h4 id=\"解决方法\">\n                解决方法\n              </h4><p>请检查 webdav 主机配置文件的 client_max_body_size，并设置适当的值</p>\n\n              <h3 id=\"无法创建文件夹状态码-409\">\n                无法创建文件夹(状态码: 409)\n              </h3>\n              <h4 id=\"原因\">\n                原因\n              </h4><p>创建文件夹时，Dolphin 发送的 MKCOL 请求，路径未以 &quot;/&quot; 结尾。nginx 对于这种行为直接返回 ”409 Conflict“</p>\n<p><a href=\"https://github.com/nginx/nginx/blob/5e5fa2e9e57b713e445b1737005ff6a202bda8ad/src/http/modules/ngx_http_dav_module.c#L504-L508\">ngx_http_dav_module.c (504-508)</a></p>\n<pre><code class=\"language-c\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r<span class=\"token operator\">-></span>uri<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>r<span class=\"token operator\">-></span>uri<span class=\"token punctuation\">.</span>len <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token function\">ngx_log_error</span><span class=\"token punctuation\">(</span>NGX_LOG_ERR<span class=\"token punctuation\">,</span> r<span class=\"token operator\">-></span>connection<span class=\"token operator\">-></span>log<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n               <span class=\"token string\">\"MKCOL can create a collection only\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token keyword\">return</span> NGX_HTTP_CONFLICT<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>至于请求路径是否该以 &quot;/&quot; 结尾，<a href=\"https://datatracker.ietf.org/doc/html/rfc2518\">rfc2518</a> 中好像没有规定，不过在<a href=\"https://datatracker.ietf.org/doc/html/rfc2518#section-8.3.3\">示例</a>里路径以 &quot;/&quot; 结尾。  </p>\n\n              <h4 id=\"解决方法\">\n                解决方法\n              </h4><p>方法1: 配置文件<br>使用 rewrite 重写路径  </p>\n<pre><code class=\"language-nginx\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$request_method</span> <span class=\"token operator\">=</span> MKCOL<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n    <span class=\"token keyword\">rewrite</span> <span class=\"token operator\">^</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">[</span><span class=\"token operator\">^</span><span class=\"token operator\">/</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>$ $<span class=\"token number\">1</span><span class=\"token operator\">/</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>方法2: 删除相关代码，重新编译<br>删除 ngx_http_dav_module.c 中相关的代码，重新编译。</p>\n\n              <h3 id=\"无法删除文件夹状态码-409\">\n                无法删除文件夹(状态码: 409)\n              </h3>\n              <h4 id=\"原因\">\n                原因\n              </h4><p>删除文件夹时，Dolphin 发送的 DELETE 请求，目录的路径未以 &quot;/&quot; 结尾。<br>nginx 会先判断是否为文件夹，如果是，就再判断路径是否以 &quot;/&quot; 结尾。不以&quot;/&quot;结尾返回 ”409 Conflict“</p>\n<p><a href=\"https://github.com/nginx/nginx/blob/5e5fa2e9e57b713e445b1737005ff6a202bda8ad/src/http/modules/ngx_http_dav_module.c#L357-L364\">ngx_http_dav_module.c (357-364)</a></p>\n<pre><code class=\"language-c\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token function\">ngx_is_dir</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>fi<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>r<span class=\"token operator\">-></span>uri<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>r<span class=\"token operator\">-></span>uri<span class=\"token punctuation\">.</span>len <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">ngx_log_error</span><span class=\"token punctuation\">(</span>NGX_LOG_ERR<span class=\"token punctuation\">,</span>r<span class=\"token operator\">-></span>connection<span class=\"token operator\">-></span>log<span class=\"token punctuation\">,</span> NGX_EISDIR<span class=\"token punctuation\">,</span>\n                        <span class=\"token string\">\"DELETE \\\"%s\\\" failed\"</span><span class=\"token punctuation\">,</span> path<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> NGX_HTTP_CONFLICT<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n</code></pre>\n\n              <h4 id=\"解决方法\">\n                解决方法\n              </h4><p>方法1: 配置文件<br>使用 rewrite 重写路径  </p>\n<pre><code class=\"language-nginx\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>d <span class=\"token variable\">$request_filename</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n    <span class=\"token keyword\">rewrite</span> <span class=\"token operator\">^</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">[</span><span class=\"token operator\">^</span><span class=\"token operator\">/</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>$ $<span class=\"token number\">1</span><span class=\"token operator\">/</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>方法2: 删除相关代码，重新编译<br>删除 ngx_http_dav_module.c 中相关的代码，重新编译。</p>\n\n              <h3 id=\"无法复制移动文件夹状态码-409\">\n                无法复制/移动文件夹(状态码: 409)\n              </h3>\n              <h4 id=\"原因\">\n                原因\n              </h4><p>没错，还tm是&quot;/&quot;的问题。。。  </p>\n<p>复制/移动文件夹时发送的 COPY/MOVE 请求，目录的路径和 Destination 头未以&quot;/&quot;结尾。Nginx 返回 409  </p>\n<p>ps: 复制文件夹的话 Dolphin 问题不大，因为它不会直接发送复制文件夹的请求。它会先创建文件夹，再复制文件。</p>\n<p><a href=\"https://github.com/nginx/nginx/blob/5e5fa2e9e57b713e445b1737005ff6a202bda8ad/src/http/modules/ngx_http_dav_module.c#L637-L646\">ngx_http_dav_module.c (637-646)</a></p>\n<pre><code class=\"language-c\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>r<span class=\"token operator\">-></span>uri<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>r<span class=\"token operator\">-></span>uri<span class=\"token punctuation\">.</span>len <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">==</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>last <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">!=</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">||</span> <span class=\"token punctuation\">(</span>r<span class=\"token operator\">-></span>uri<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">[</span>r<span class=\"token operator\">-></span>uri<span class=\"token punctuation\">.</span>len <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">!=</span> <span class=\"token string\">'/'</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">(</span>last <span class=\"token operator\">-</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">==</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token function\">ngx_log_error</span><span class=\"token punctuation\">(</span>NGX_LOG_ERR<span class=\"token punctuation\">,</span> r<span class=\"token operator\">-></span>connection<span class=\"token operator\">-></span>log<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token string\">\"both URI \\\"%V\\\" and \\\"Destination\\\" URI \\\"%V\\\" \"</span>\n                    <span class=\"token string\">\"should be either collections or non-collections\"</span><span class=\"token punctuation\">,</span>\n                    <span class=\"token operator\">&amp;</span>r<span class=\"token operator\">-></span>uri<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>dest<span class=\"token operator\">-></span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> NGX_HTTP_CONFLICT<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n</code></pre>\n\n              <h4 id=\"解决方法\">\n                解决方法\n              </h4><p>适用于 Dolphin 或类似机制的客户端无法复制文件夹的解决方法同 <a href=\"#\">无法创建文件夹</a></p>\n<p>通用:<br>方法1: 配置文件<br>使用 rewrite 和 more_set_input_headers(需要 headers-more-nginx-module) 重写路径和 Destination 头</p>\n<pre><code class=\"language-nginx\"><span class=\"token keyword\">set</span> <span class=\"token variable\">$is_copy_or_move</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">set</span> <span class=\"token variable\">$is_dir</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">-</span>d <span class=\"token variable\">$request_filename</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n    <span class=\"token keyword\">set</span> <span class=\"token variable\">$is_dir</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$request_method</span> <span class=\"token operator\">=</span> COPY<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">set</span> <span class=\"token variable\">$is_copy_or_move</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$request_method</span> <span class=\"token operator\">=</span> MOVE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">set</span> <span class=\"token variable\">$is_copy_or_move</span> <span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">set</span> <span class=\"token variable\">$is_rewrite</span> <span class=\"token string\">\"${is_dir}${is_copy_or_move}\"</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$is_rewrite</span> <span class=\"token operator\">=</span> <span class=\"token number\">11</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> \n    more_set_input_headers <span class=\"token string\">'Destination: $http_destination/'</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">rewrite</span> <span class=\"token operator\">^</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">.</span><span class=\"token operator\">*</span><span class=\"token punctuation\">[</span><span class=\"token operator\">^</span><span class=\"token operator\">/</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>$ $<span class=\"token number\">1</span><span class=\"token operator\">/</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre>\n<p>方法2: 删除相关代码，重新编译<br>删除 ngx_http_dav_module.c 中相关的代码，重新编译。</p>\n<!-- todo\n## 不显示含非英文字符文件及文件夹\n这个我不确定，不过大概率是编码的问题。\n-->\n\n\n              <h2 id=\"成果\">\n                成果\n              </h2><p>这是修复以上问题的 docker 镜像\n<a href=\"https://hub.docker.com/r/1574242600/webdav\">https://hub.docker.com/r/1574242600/webdav</a></p>\n\n              <h2 id=\"参考\">\n                参考\n              </h2><ol>\n<li><a href=\"http://netlab.dhis.org/wiki/ru:software:nginx:webdav\">Nginx and Microsoft Windows WebClient (WebDav)</a>  / <a href=\"https://web.archive.org/web/20201026211658/http://netlab.dhis.org/wiki/ru:software:nginx:webdav\">Archived</a></li>\n<li><a href=\"https://cetteup.com/36/cant-create-or-delete-directories-on-an-nginx-webdav-server-here-is-how-to-fix-that/\">Can’t create or delete directories on an NGINX WebDAV server? Here’s how to fix that!</a> / <a href=\"https://web.archive.org/web/20210521142218/https://cetteup.com/36/cant-create-or-delete-directories-on-an-nginx-webdav-server-here-is-how-to-fix-that/\">Archived</a></li>\n<li><a href=\"https://datatracker.ietf.org/doc/html/rfc2518\">rfc2518</a></li>\n</ol>\n"}},"pageContext":{"id":"fe981d7e-7f8b-55e8-9722-c0cbf9cd172b"}},"staticQueryHashes":["1528757306","3042919606","3159585216","3741834850","4209591199","847439237"]}